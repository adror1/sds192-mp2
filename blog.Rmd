---
title: "Mini-Project 2"
authors: "Margaret Perry, Kendra Swanson, Arielle Dror"
date: "March 24, 2017"
output: html_document
---


##Goal
The goal of this code is to tidy and graph the data to display the corrolations between the cortributions and the success of the candidate. In the end we want three bar graphs displaying Tea party, Rep party, and Dem party with candidates on the x axis, contributions on the y axis, and colored according to whether each candidate won or lost.

To handle contributions for vs contributions against: stack bar graph. Use value to differentiate for or against, and color to differentiate winning or losing (eg. a candidate who won will have contributions represented as dark blue for contributions for and light blue for contributions against, and a candidate who lost will have contributions represented as dark green for contributions for and light green for contributions against.)

We're focusing just on general elections.

Once the full data table is complete, write a function to filter by state OR don't create master table and only create function to filter by state (more efficient).

```{r, include=FALSE}
library(tidyverse)
library(dplyr)
library(tidyr)
library(ggplot2)
library(RColorBrewer)
library(grDevices)
library(colorRamps)
load("house_elections.rda")
load("candidates.rda")
load("committees.rda")
load("contributions.rda")
```

```{r}
##Renaming columns for clarity and easier join
names(contributions)[names(contributions)=="name"] <- "cmte_name"

house_elections <- house_elections %>%
  mutate(candidate_name = toupper(candidate_name))
```

```{r}
## Function that produces candidate information by state and office in 2012 election cycle

office_state_cands <- function(office_arg, state_arg) {
  filter(candidates, cand_office == office_arg, cand_election_yr == "2012", cand_office_state == state_arg)
}

## Examples (delete/comment out in final submission)
CA_house <- office_state_cands(office_arg = "H", state_arg = "CA")
CA_house

pres_cands <- office_state_cands(office_arg = "P", state_arg = "US")
pres_cands

```

```{r}
## Functions that total COMMITTEE contributions for and contributions against each candidate
## in a given table of candidates. 

cand_for <- function(data_arg) {
  data_arg %>%
    left_join(contributions, by = "cand_id") %>%
    filter(transaction_amt > 0, transaction_type == "24K" | transaction_type == "24E" | transaction_type == "24F" | transaction_type == "24C" | transaction_type == "24Z") %>%
    group_by(cand_name) %>%
    summarize(total_for = sum(transaction_amt))
}

cand_against <- function(data_arg) {
  data_arg %>%
    left_join(contributions, by = "cand_id") %>%
    filter(transaction_amt > 0, transaction_type == "24A" | transaction_type == "24N") %>%
    group_by(cand_name) %>%
    summarize(total_against = sum(transaction_amt))
}


## Examples
CA_house_cand_for <- cand_for(data_arg = CA_house)
CA_house_cand_for

CA_house_cand_against <- cand_against(data_arg = CA_house)
CA_house_cand_against

```
Transaction codes: 24A, 24N = against; 24E, 24F, 24C, 24K, 24Z = for

```{r}
## Function that determines whether a candidate has won or lost given a table of candidates
## **Note: only works for house elections** 
cand_success <- function(data_arg) {
  data_arg %>%
    left_join(house_elections, by = c("cand_id" = "fec_id")) %>%
    select(cand_name, primary_votes, general_votes, ge_winner)
}
cand_success(data_arg = office_state_cands(office_arg = "H", state_arg = "CA"))

```


```{r}
## Function that joins for, against, success, and candidates table given a table of candidates
cand_info <- function(cand_table) {
  cand_table %>%
    left_join(cand_for(data_arg = cand_table), by = "cand_name") %>%
    full_join(cand_against(data_arg = cand_table), by = "cand_name") %>%
    left_join(cand_success(data_arg = cand_table), by = "cand_name") %>%
    mutate(total = ifelse(!is.na(total_against) & !is.na(total_for), total_for + total_against, 
                          ifelse(is.na(total_against), total_for, 
                                 ifelse(is.na(total_for), total_against, 0)))) %>%
    mutate(prop_against=(total_against/total)*100) %>%
    filter(total_for > 0 & total_against > 0 & general_votes > 0) %>%
    select(cand_id, cand_name, cand_party_affiliation, cand_state, cand_office, cand_office_district, total_for, total_against, total, general_votes, ge_winner, prop_against) %>%
  group_by(general_votes)
}


CA_house_cand_info <- cand_info(cand_table = office_state_cands(office_arg = "H", state_arg = "CA"))

CA_house_cand_info
```

```{r}
candidate_graphic_1 <- ggplot(CA_house_cand_info, aes(x=cand_name, y= total, fill=prop_against))+coord_flip()+geom_bar(stat="identity")+scale_fill_continuous(low="firebrick1", high = "firebrick4")


candidate_graphic_1
```
```{r}
candidate_graphic_2 <- ggplot(CA_house_cand_info, aes(x=cand_name, y= total, fill=ge_winner))+coord_flip()+geom_bar(stat="identity")
candidate_graphic_2
```

## Old code

<!-- ```{r} -->
<!-- cmte_by_party <- function(party_arg) { -->
<!--   committees %>% -->
<!--     group_by(cmte_city) %>% -->
<!--     filter(cmte_party_affiliation == party_arg) %>% -->
<!--     select(cmte_name, cmte_dsgn, cmte_city, cmte_state, connected_org_name, cand_id) -->
<!-- } -->

<!-- democratic_cmte <- cmte_by_party("DEM") -->
<!-- republican_cmte <- cmte_by_party("REP") -->
<!-- teaparty_cmte <- cmte_by_party("TEA") -->


<!-- candidates_simple <- candidates %>% -->
<!--   select(cand_id, cand_name, cand_party_affiliation, cand_office_state, cand_city) -->

<!-- ``` -->

<!-- ```{r} -->
<!-- ##Building main data table -->
<!-- candidates_contributions <- contributions %>% -->
<!--   full_join(candidates_simple, by = "cand_id")%>% -->
<!--   select(cand_name, cand_party_affiliation, cmte_id, cmte_name, transaction_type, transaction_amt) -->
<!-- ##head(candidates_contributions) -->

<!-- candidates_full <- house_elections %>% -->
<!--   full_join(candidates_contributions, by = "cand_name") %>% -->
<!--   select(cand_name, cand_party_affiliation, cmte_id, cmte_name, transaction_type, transaction_amt, general_votes, ge_winner, statoe, district) %>% -->
<!--   filter(state == "NV", transaction_amt > 0, general_votes > 0, (transaction_type == "24A" | transaction_type == "24E")) -->



<!-- candidates_full -->
<!-- ``` -->

```{r}
candidate_graphic <- ggplot(candidates_full, (cand_name, ))

```

